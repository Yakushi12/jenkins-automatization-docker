pipeline {

  environment {
    PASS = credentials('pass')
  }

  agent {
    label "master"
  }

  parameters {
    string(defaultValue: "", description: "", name: "GIT_COMMIT")
  }

  stages {
    stage("clone code") {
      steps {
        script {
          git credentialsId: "{{ credentials }}",
          branch: "{{ targetBranch }}",
          url: "{{ gitCIurl }}";
        }
      }
    }
    stage("get vars") {
      steps {
        script {
          env.NEXUS_IP = sh (
            script: 'gcloud secrets versions access "latest" --secret="{{ nexus_ip_secret }}"',
            returnStdout: true
            ).trim();
      }
    }
    stage('Create Packer AMI') {
      steps {
        dir('Ansible_packer_job/'){
          sh("gcloud secrets versions access latest --secret='{{ service_acc_key }}' > account.json")
          sh """
          packer build \
          -var \'path=${PASS}\' \
          -var \'acc_key=account.json\' \
          -var \'nexus_url=${NEXUS_IP}\' \
          -var \'commit_id=${GIT_COMMIT}\' \
          pet_centos72.json
          """
        }
      }
    }
    stage("downstream") {
      steps {
        build(job: 'terraform_build_DEV')
      }
    }
  }

  post {
    cleanup {
      cleanWs()
    }
  }
}
