#!groovy

import javaposse.jobdsl.dsl.DslScriptLoader
import javaposse.jobdsl.plugin.JenkinsJobManagement
import jenkins.model.Jenkins
import javaposse.jobdsl.dsl.DslFactory.*

def jobDSL="""
pipelineJob('packer_build') {
  logRotator(7, -1, -1, -1)
  parameters {
    stringParam('GIT_COMMIT', '', '')
  }
  definition {
    cpsScm {
      scm {
        git {
          remote {
            url('{{ git_pipelines_url }}')
            credentials('{{ github_ssh_credentials }}')
          }
       branch('{{ branch }}')
       }
       scriptPath('Jenkinsfile-packer_build')
     }
    lightweight()
   }
  }
}
""";

def jobManagement = new JenkinsJobManagement(System.out, [:], new File('.'))
new DslScriptLoader(jobManagement).runScript(jobDSL)
def scriptApproval = org.jenkinsci.plugins.scriptsecurity.scripts.ScriptApproval.get()

String[] signs = [
    "method org.jenkinsci.plugins.workflow.steps.FlowInterruptedException getCauses",
    "method org.jenkinsci.plugins.workflow.support.steps.input.Rejection getUser"
    ]

for( String sign : signs ) {
    scriptApproval.approveSignature(sign)
}

scriptApproval.save()
